@model UserProfileViewModel
@{
    ViewData["Title"] = "Мой профиль";
}

<h2>Мой профиль</h2>

@* @if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
} *@

<form method="post" class="mb-4">
    <input type="hidden" asp-for="Id" />
    <input type="hidden" asp-for="UserName" />

    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Имя *</label>
            <input asp-for="FirstName" class="form-control" required />
            <span asp-validation-for="FirstName" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label class="form-label">Фамилия *</label>
            <input asp-for="LastName" class="form-control" required />
            <span asp-validation-for="LastName" class="text-danger"></span>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">Email *</label>
        <input asp-for="Email" class="form-control" type="email" required />
        <span asp-validation-for="Email" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Телефон</label>
        <input asp-for="PhoneNumber" class="form-control" />
        <span asp-validation-for="PhoneNumber" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">О себе</label>
        <textarea asp-for="Bio" class="form-control" rows="3"></textarea>
        <span asp-validation-for="Bio" class="text-danger"></span>
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Сохранить изменения</button>
        <a href="/User/Profile" class="btn btn-secondary">Обновить страницу</a>
        <button type="button" class="btn btn-outline-warning" onclick="testUpdate()">Тест обновления</button>
    </div>
</form>

<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Текущие данные профиля</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>ID:</strong> <code>@Model.Id</code></p>
                <p><strong>Имя пользователя:</strong> @Model.UserName</p>
                <p><strong>Email:</strong> @Model.Email</p>
            </div>
            <div class="col-md-6">
                <p><strong>Имя:</strong> @Model.FirstName</p>
                <p><strong>Фамилия:</strong> @Model.LastName</p>
                <p><strong>Телефон:</strong> @(string.IsNullOrEmpty(Model.PhoneNumber) ? "Не указан" : Model.PhoneNumber)</p>
            </div>
        </div>
        
        @if (!string.IsNullOrEmpty(Model.Bio))
        {
            <div class="mt-3">
                <p><strong>О себе:</strong></p>
                <p class="text-muted">@Model.Bio</p>
            </div>
        }
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h5 class="mb-0">Тестирование API</h5>
    </div>
    <div class="card-body">
        <button class="btn btn-info mb-2" onclick="simpleTest()">
            Простой тест (обновить только имя)
        </button>
        <div id="testResult" class="mt-2"></div>
    </div>
</div>

@section Scripts {
    <script>
        function testUpdate() {
            console.log('Testing form submission...');
            document.querySelector('form').submit();
        }

        function simpleTest() {
            const testData = {
                FirstName: 'Test_' + new Date().getTime(),
                LastName: 'TestLastName',
                Email: document.querySelector('input[name="Email"]').value,
                PhoneNumber: '+1234567890',
                Bio: 'Test bio'
            };

            console.log('Sending test data:', testData);

            fetch('/User/TestUpdate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            })
            .then(response => response.text())
            .then(text => {
                document.getElementById('testResult').innerHTML =
                    `<div class="alert alert-info">${text}</div>`;
                console.log('Test result:', text);
                setTimeout(() => location.reload(), 2000);
            })
            .catch(error => {
                document.getElementById('testResult').innerHTML =
                    `<div class="alert alert-danger">Error: ${error}</div>`;
            });
        }
    </script>
}